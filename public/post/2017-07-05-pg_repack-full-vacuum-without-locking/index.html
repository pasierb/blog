<!DOCTYPE html>
<html lang="en">
  
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>pg_repack - full vacuum without table lock  - dev.log</title>
  <meta property="og:title" content="pg_repack - full vacuum without table lock " />
  <meta name="twitter:title" content="pg_repack - full vacuum without table lock " />
  <meta name="description" content="In PostgreSQL, an UPDATE or DELETE of a row does not immediately remove the old version of the row. If you have application that does this massive batch UPDATEs or DELETEs your database can grow in size pretty quickly.
At [ISE][ise] we develop plant performance monitoring application which collects hundreds (somtimes &gt; 1000) of data counters ever minute. This &ldquo;minute-by-minute&rdquo; data is later compressed into hourly slots. This process involves massive DELETE operations every hour.">
  <meta property="og:description" content="In PostgreSQL, an UPDATE or DELETE of a row does not immediately remove the old version of the row. If you have application that does this massive batch UPDATEs or DELETEs your database can grow in size pretty quickly.
At [ISE][ise] we develop plant performance monitoring application which collects hundreds (somtimes &gt; 1000) of data counters ever minute. This &ldquo;minute-by-minute&rdquo; data is later compressed into hourly slots. This process involves massive DELETE operations every hour.">
  <meta name="twitter:description" content="In PostgreSQL, an UPDATE or DELETE of a row does not immediately remove the old version of the row. If you have application that does this massive batch UPDATEs or DELETEs your database can grow in â€¦">
  <meta name="author" content="Michal Pasierbski"/>
  <meta property="og:image" content="http://example.org/me.jpeg" />
  <meta name="twitter:image" content="http://example.org/me.jpeg" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@mpasierbski" />
  <meta name="twitter:creator" content="@mpasierbski" />
  <meta property="og:url" content="http://example.org/post/2017-07-05-pg_repack-full-vacuum-without-locking/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="dev.log" />

  <meta name="generator" content="Hugo 0.49.2" />
  <link rel="canonical" href="http://example.org/post/2017-07-05-pg_repack-full-vacuum-without-locking/" />
  <link rel="alternate" href="http://example.org/index.xml" type="application/rss+xml" title="dev.log">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="http://example.org/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="http://example.org/css/syntax.css" /><link rel="stylesheet" href="http://example.org/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://example.org/">dev.log</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="CV" href="https://pasierb.github.io/cv/">CV</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="dev.log" href="http://example.org/">
            <img class="avatar-img" src="http://example.org/me.jpeg" alt="dev.log" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>pg_repack - full vacuum without table lock </h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fa fa-calendar-o"></i>&nbsp;Posted on July 5, 2017
  
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        

<p>In <strong>PostgreSQL</strong>, an UPDATE or DELETE of a row does not immediately remove the old version of the row.
If you have application that does this massive batch UPDATEs or DELETEs your database can <strong>grow in size pretty quickly</strong>.</p>

<p>At [ISE][ise] we develop plant performance monitoring application which collects hundreds (somtimes &gt; 1000) of data counters ever minute.
This &ldquo;minute-by-minute&rdquo; data is later compressed into hourly slots.
This process involves massive DELETE operations every hour.</p>

<p>To reclaim disk space you need <strong>FULL VACUUM</strong>, but it <strong>locks tables</strong> which is a huge &ldquo;no no&rdquo; in 24-7-365 industry monitoring application.</p>

<p><strong><a href="https://github.com/reorg/pg_repack">pg_repack</a></strong> is a PostgreSQL extension tool that can do pretty much what FULL VACUUM does <strong>without locking</strong> (minimum locking to be precise).</p>

<h3 id="installation">Installation</h3>

<p>You can install from <a href="https://pgxn.org/dist/pg_repack/">source</a> or through pgxn.</p>

<pre><code class="language-bash">apt-get install pgxnclient postgresql-server-dev-all
pgxn install pg_repack
psql -c &quot;CREATE EXTENSION pg_repack&quot; -d YOUR_DB_NAME -U postgres
</code></pre>

<h3 id="usage">Usage</h3>

<pre><code class="language-bash">/usr/lib/postgresql/9.x/bin/pg_repack -d YOUR_DB_NAME -U postgres
</code></pre>

<h3 id="notes">Notes</h3>

<p>You will need around the same amount of space available as the table being repacked.
The reason is that pg_repack is actually creating a fresh copy of table without &ldquo;dead&rdquo; space and replacing old one with new (just as FULL VACUUM does)</p>

<p>P.S.</p>

<p>Of course it does not mean that you should abbandon your regulary scheduled vacuumimg and reindexing!</p>

<p>Sources:
- <a href="https://www.postgresql.org/docs/9.2/static/routine-vacuuming.html">PostgreSQL rutine vacuuming documentation</a>
- <a href="https://www.postgresql.org/docs/9.1/static/sql-vacuum.html">PostgreSQL vacuum documentation</a>
- <a href="https://github.com/reorg/pg_repack">pg_repack github project</a>
- <a href="https://pgxn.org/dist/pg_repack/">pg_repack pgxn site</a></p>


        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
          
            <li class="next">
              <a href="http://example.org/post/2017-07-05-dealing-with-procrastination-daily-todo/" data-toggle="tooltip" data-placement="top" title="Dealing with procrastination #1 - daily TODO">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="https://github.com/pasierb" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/mpasierbski" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/mpasierbski" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            
            <a href="http://example.org/index.xml" title="RSS">
            
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Michal Pasierbski
            
          

          &nbsp;&bull;&nbsp;
          2017

          
            &nbsp;&bull;&nbsp;
            <a href="http://example.org/">dev.log</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.49.2</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="http://example.org/js/main.js"></script><script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script>
<script src="http://example.org/js/load-photoswipe.js"></script>








  </body>
</html>

